<link rel="import" href="../polymer/polymer-element.html">

<!--
`<pt-select>` is a single select field.
    <pt-select options="[[options]]" value="{{currentValue}}"></pt-select>
-->

<dom-module id="pt-select">
  <template>
    <style>
     :host {
      margin: 12px;
      padding: 4px;
      min-width: 80px;
      overflow: hidden;
    }

    select {
      color: var(--pt-accent-color);
      background-color: transparent;

      border: none;
      border-bottom: 1px solid rgba(0, 0, 0, 0.12);

      font-size: 16px;
      text-transform: capitalize;
      cursor: pointer;
    }

    :host([value='']) select {
      color: var(--pt-primary-text-color,#000);
    }

    select.invalid {
      border-bottom: 1px solid #F44336;
    }

    select:focus {
      outline: none;
    }
    </style>
    
    <select value="[[value]]" on-change="_valueSelected">
			<template is="dom-repeat" items="[[_mapItems(options, pathToValue, pathToLabel)]]">
				<option value="[[item.uid]]">[[item.name]]</option>
      </template>
    </select>
    
  </template>

  <script>
    /**
     * `pt-select`
     * Select Polymer Element
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class PtSelect extends Polymer.Element {
      static get is() { return 'pt-select'; }
      
      static get properties(){
		  return {
			options: Array,
			value: {
			  type: String,
			  notify: true,
			  reflectToAttribute: true,
			  value: ''
			},
			option: {
			  type: Object,
			  notify: true,
			},

			placeholder: {
			  type: String,
			  observer: '_placeholderChanged'
			},

			pathToValue: {
			  type: String,
			  value: 'uid'
			},
			pathToLabel: {
			  type: String,
			  value: 'name'
			}
		  };
		}
    
    _placeholderChanged(placeholder){
		  let element = this.shadowRoot.querySelector('.placeholder');

		  if (placeholder) {
			if (!element) {
			  element = document.createElement('option');
			  element.classList.add('placeholder');
			  element.disabled = true;
			  element.value = '';
			  let parent = this.shadowRoot.querySelector('select');
			  parent.insertBefore(element, parent.firstElementChild);
			  parent.value = '';
			}

			element.innerText = placeholder;
		  } else {
			if (element) {
			  this.shadowRoot.removeChild(element);
			}
		  }
		}

		_valueSelected(e){
		  this.set('value', e.target.value);
		  this.set('option', this._options[this.value].option);
		  this.dispatchEvent(new CustomEvent('option-changed', {
			detail: {
			  value: this.value,
			  option: this.option
			}
		  }));
		}

		_mapItems(options, pathToValue, pathToLabel){
		  if (options && pathToValue && pathToLabel) {
			let _options = {};
			let uid;
			let result = options.map((option) =>{
			  uid = this._extractPath(option, pathToValue);

			  return _options[uid] = {
				uid: uid,
				name: this._extractPath(option, pathToLabel),
				option: option
			  }
			});

			this._options = _options;
			return result;
		  }
		}

		_extractPath(item, path){
		  let value = item;
		  path = path.split('.');
		  path.forEach((step) =>{
			value = value[step] || {};
		  });
		  return value;
		}

    }

    window.customElements.define(PtSelect.is, PtSelect);
  </script>
</dom-module>
